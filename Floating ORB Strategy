//@version=6
// DISCLAIMER: This strategy is provided "as is" for educational and backtesting purposes only. BucksTRDR is not responsible for trading decisions made using this tool. Always do your own research and consult a financial professional.
strategy('Floating ORB Strategy by BucksTRDR', overlay=true,
         fill_orders_on_standard_ohlc=true,
         initial_capital=1000000,
         default_qty_type=strategy.fixed,
         default_qty_value=1,
         commission_type=strategy.commission.percent,
         commission_value=0.1,
         slippage=2,
         pyramiding=1)

// === Strategy Inputs ===
volumeMALength = input.int(20, title='Volume MA Length', minval=1, group='Volume Settings', tooltip='Length for volume moving average')
volumeMultiplier = input.float(1.5, title='Volume Multiplier', minval=0.1, step=0.1, group='Volume Settings', tooltip='Minimum volume multiplier vs MA (e.g. 1.5 = 150%)')

minCandleRange = input.float(5.0, title='Min Trigger Candle Range (points)', minval=0.1, step=0.1, group='Candle Filters', tooltip='Minimum size of trigger candle in points')
maxCandleRange = input.float(50.0, title='Max Trigger Candle Range (points)', minval=0.1, step=1.0, group='Candle Filters', tooltip='Maximum size of trigger candle in points')
minTrailCandleSize = input.float(3.0, title='Min Candle Size for Trailing (points)', minval=0.1, step=0.1, group='Candle Filters', tooltip='Minimum candle size to move stop loss')

tickOffset = input.float(2.0, title='Tick Offset for First SL Move', minval=0, step=0.5, group='Stop Loss Settings', tooltip='Offset in ticks for first stop loss move (to cover fees)')

// === Time Filter Inputs ===
enableTimeFilter = input.bool(true, title='Enable Time Filter', group='Time Filter', tooltip='Only trade during specific hours')
tradingSession = input.session('0930-1600', title='Trading Hours', group='Time Filter', tooltip='Time window for entries (in exchange timezone)')
closeOutsideHours = input.bool(false, title='Close Positions Outside Hours', group='Time Filter', tooltip='Close any open positions when outside trading hours')

// Debug option
showDebugLabels = input.bool(true, title='Show Debug Labels', group='Display', tooltip='Show debug information on chart')
showFailedConditions = input.bool(true, title='Show Failed Condition Labels', group='Display', tooltip='Show why trades did not trigger')

// === Timeframe Check ===
is5min = timeframe.isintraday and timeframe.multiplier == 5

// === Time Filter Check ===
inTradingWindow = not enableTimeFilter or not na(time(timeframe.period, tradingSession))

// === Volume Calculations ===
volumeMA = ta.sma(volume, volumeMALength)
volumeCondition = volume >= volumeMultiplier * volumeMA

// === Candle Calculations ===
candleRange = high - low
candleIsBullish = close > open
candleIsBearish = close < open

// === Trigger Candle Conditions ===
validCandleRange = candleRange >= minCandleRange and candleRange <= maxCandleRange
triggerLong = is5min and candleIsBullish and volumeCondition and validCandleRange and inTradingWindow
triggerShort = is5min and candleIsBearish and volumeCondition and validCandleRange and inTradingWindow

// === Debug Failed Conditions ===
if showFailedConditions and strategy.position_size == 0
    // Check if we have a potential signal but missing one condition
    potentialLong = candleIsBullish and (volumeCondition or validCandleRange or is5min or inTradingWindow)
    potentialShort = candleIsBearish and (volumeCondition or validCandleRange or is5min or inTradingWindow)

    if potentialLong and not triggerLong
        debugText = 'âš ï¸ LONG SIGNAL FAILED:\n'
        debugText := debugText + 'Timeframe: ' + (is5min ? 'âœ“' : 'âœ— NOT 5min') + '\n'
        debugText := debugText + 'Bullish: ' + (candleIsBullish ? 'âœ“' : 'âœ—') + '\n'
        debugText := debugText + 'Volume: ' + (volumeCondition ? 'âœ“' : 'âœ— ' + str.tostring(volume/volumeMA, '#.##') + 'x MA') + '\n'
        debugText := debugText + 'Range: ' + (validCandleRange ? 'âœ“' : 'âœ— ' + str.tostring(candleRange, '#.##') + ' pts') + '\n'
        debugText := debugText + 'Min: ' + str.tostring(minCandleRange, '#.#') + ' Max: ' + str.tostring(maxCandleRange, '#.#') + '\n'
        debugText := debugText + 'Time: ' + (inTradingWindow ? 'âœ“' : 'âœ— Outside hours')
        label.new(bar_index, high, debugText, style=label.style_label_down, color=color.new(color.orange, 0), textcolor=color.black, size=size.tiny)

    if potentialShort and not triggerShort
        debugText = 'âš ï¸ SHORT SIGNAL FAILED:\n'
        debugText := debugText + 'Timeframe: ' + (is5min ? 'âœ“' : 'âœ— NOT 5min') + '\n'
        debugText := debugText + 'Bearish: ' + (candleIsBearish ? 'âœ“' : 'âœ—') + '\n'
        debugText := debugText + 'Volume: ' + (volumeCondition ? 'âœ“' : 'âœ— ' + str.tostring(volume/volumeMA, '#.##') + 'x MA') + '\n'
        debugText := debugText + 'Range: ' + (validCandleRange ? 'âœ“ ' : 'âœ— ' + str.tostring(candleRange, '#.##') + ' pts') + '\n'
        debugText := debugText + 'Min: ' + str.tostring(minCandleRange, '#.#') + ' Max: ' + str.tostring(maxCandleRange, '#.#') + '\n'
        debugText := debugText + 'Time: ' + (inTradingWindow ? 'âœ“' : 'âœ— Outside hours')
        label.new(bar_index, low, debugText, style=label.style_label_up, color=color.new(color.orange, 0), textcolor=color.black, size=size.tiny)

// === Track Position State ===
var float entryPrice = na
var float currentStopLoss = na
var int tradeDirection = 0  // 1 = long, -1 = short, 0 = no position
var bool firstTrailMove = false  // Track if we've made the first SL adjustment
var float lastCandleClose = na  // Track previous candle close for trailing

// === Entry Logic ===
if (triggerLong and strategy.position_size == 0)
    entryPrice := close
    currentStopLoss := low
    tradeDirection := 1
    firstTrailMove := false
    lastCandleClose := close
    strategy.entry('Long', strategy.long)

    if showDebugLabels
        label.new(bar_index, high, 'ðŸŸ¢ LONG ENTRY\nEntry: ' + str.tostring(close, format.mintick) + '\nSL: ' + str.tostring(low, format.mintick) + '\nVol: ' + str.tostring(volume/volumeMA, '#.##') + 'x',
                  style=label.style_label_down, color=color.new(color.lime, 0), textcolor=color.black, size=size.normal)

if (triggerShort and strategy.position_size == 0)
    entryPrice := close
    currentStopLoss := high
    tradeDirection := -1
    firstTrailMove := false
    lastCandleClose := close
    strategy.entry('Short', strategy.short)

    if showDebugLabels
        label.new(bar_index, low, 'ðŸ”´ SHORT ENTRY\nEntry: ' + str.tostring(close, format.mintick) + '\nSL: ' + str.tostring(high, format.mintick) + '\nVol: ' + str.tostring(volume/volumeMA, '#.##') + 'x',
                  style=label.style_label_up, color=color.new(color.fuchsia, 0), textcolor=color.white, size=size.normal)

// === Exit Orders (Stop Loss) ===
if strategy.position_size > 0
    strategy.exit('Long SL', 'Long', stop=currentStopLoss)

if strategy.position_size < 0
    strategy.exit('Short SL', 'Short', stop=currentStopLoss)

// === Trailing Stop Logic ===
// For Long positions
if strategy.position_size > 0 and tradeDirection == 1
    // First adjustment: Move SL to breakeven + offset once price moves favorably
    if not firstTrailMove and close > entryPrice
        newStopLoss = entryPrice + (tickOffset * syminfo.mintick)
        if newStopLoss > currentStopLoss
            currentStopLoss := newStopLoss
            firstTrailMove := true
            if showDebugLabels
                label.new(bar_index, currentStopLoss, 'ðŸ”µ SLâ†’BE+' + str.tostring(tickOffset),
                          style=label.style_label_left, color=color.new(color.blue, 30), textcolor=color.white, size=size.tiny)

    // Subsequent trailing: Move SL behind each candle's low (if candle is big enough)
    if firstTrailMove and (high - low) >= minTrailCandleSize
        newStopLoss = low
        if newStopLoss > currentStopLoss
            currentStopLoss := newStopLoss
            if showDebugLabels
                label.new(bar_index, currentStopLoss, 'ðŸ”µ SL Trail',
                          style=label.style_label_left, color=color.new(color.blue, 30), textcolor=color.white, size=size.tiny)

// For Short positions
if strategy.position_size < 0 and tradeDirection == -1
    // First adjustment: Move SL to breakeven - offset once price moves favorably
    if not firstTrailMove and close < entryPrice
        newStopLoss = entryPrice - (tickOffset * syminfo.mintick)
        if newStopLoss < currentStopLoss
            currentStopLoss := newStopLoss
            firstTrailMove := true
            if showDebugLabels
                label.new(bar_index, currentStopLoss, 'ðŸ”µ SLâ†’BE+' + str.tostring(tickOffset),
                          style=label.style_label_left, color=color.new(color.blue, 30), textcolor=color.white, size=size.tiny)

    // Subsequent trailing: Move SL behind each candle's high (if candle is big enough)
    if firstTrailMove and (high - low) >= minTrailCandleSize
        newStopLoss = high
        if newStopLoss < currentStopLoss
            currentStopLoss := newStopLoss
            if showDebugLabels
                label.new(bar_index, currentStopLoss, 'ðŸ”µ SL Trail',
                          style=label.style_label_left, color=color.new(color.blue, 30), textcolor=color.white, size=size.tiny)

// === Close Positions Outside Trading Hours ===
if closeOutsideHours and not inTradingWindow
    if strategy.position_size > 0
        strategy.close('Long', comment='Outside Trading Hours')
    if strategy.position_size < 0
        strategy.close('Short', comment='Outside Trading Hours')

// === Reset on Position Close ===
if strategy.position_size == 0 and strategy.position_size[1] != 0
    entryPrice := na
    currentStopLoss := na
    tradeDirection := 0
    firstTrailMove := false
    lastCandleClose := na

// === Visual Reference ===
// Plot entry signals
plotshape(triggerLong, title='Long Trigger', style=shape.triangleup, location=location.belowbar, color=color.new(color.green, 0), size=size.small)
plotshape(triggerShort, title='Short Trigger', style=shape.triangledown, location=location.abovebar, color=color.new(color.red, 0), size=size.small)

// Plot stop loss and entry lines
plot(strategy.position_size != 0 ? currentStopLoss : na, title='Stop Loss', color=color.red, linewidth=2, style=plot.style_linebr)
plot(strategy.position_size != 0 ? entryPrice : na, title='Entry Price', color=color.blue, linewidth=1, style=plot.style_linebr)

// === Volume & Position Reference ===
bgcolor(volumeCondition ? color.new(color.blue, 95) : na, title='High Volume Background')

// Highlight when strategy has an active position
bgcolor(strategy.position_size > 0 ? color.new(color.green, 90) : na, title='Long Position Active')
bgcolor(strategy.position_size < 0 ? color.new(color.red, 90) : na, title='Short Position Active')
