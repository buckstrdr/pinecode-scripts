//@version=6
// DISCLAIMER: This strategy is provided "as is" for educational and backtesting purposes only. BucksTRDR is not responsible for trading decisions made using this tool. Always do your own research and consult a financial professional.
strategy('Supertrend Strategy by BucksTRDR', overlay=true,
         fill_orders_on_standard_ohlc=true,
         initial_capital=100000,
         default_qty_type=strategy.percent_of_equity,
         default_qty_value=100,
         commission_type=strategy.commission.percent,
         commission_value=0.1,
         pyramiding=0)

// === Inputs ===
Periods = input.int(title='ATR Period', defval=10, minval=1, group='Supertrend Settings', tooltip='Period for ATR calculation')
src = input(hl2, title='Source', group='Supertrend Settings', tooltip='Price source for calculations')
Multiplier = input.float(title='ATR Multiplier', step=0.1, defval=3.0, minval=0.1, group='Supertrend Settings', tooltip='Multiplier for ATR bands')
changeATR = input.bool(title='Change ATR Calculation Method?', defval=true, group='Supertrend Settings', tooltip='Use built-in ATR vs SMA of TR')
showsignals = input.bool(title='Show Buy/Sell Signals?', defval=true, group='Display', tooltip='Show buy/sell labels on chart')
highlighting = input.bool(title='Highlighter On/Off?', defval=true, group='Display', tooltip='Highlight trend direction with fills')

// === Strategy Settings ===
useTakeProfit = input.bool(title='Use Take Profit', defval=true, group='Risk Management', tooltip='Enable RR-based take profit')
riskRewardRatio = input.float(title='Risk:Reward Ratio', defval=2.0, minval=0.5, step=0.5, group='Risk Management', tooltip='Risk-reward ratio for take profit (e.g., 2.0 = 2:1)')
trailWithSupertrend = input.bool(title='Trail Stop with Supertrend', defval=true, group='Risk Management', tooltip='Use Supertrend line as trailing stop')

// === ATR Calculation ===
atr2 = ta.sma(ta.tr, Periods)
atr = changeATR ? ta.atr(Periods) : atr2

// === Supertrend Calculation ===
up = src - (Multiplier * atr)
up1 = nz(up[1], up)
up := close[1] > up1 ? math.max(up, up1) : up

dn = src + (Multiplier * atr)
dn1 = nz(dn[1], dn)
dn := close[1] < dn1 ? math.min(dn, dn1) : dn

trend = 1
trend := nz(trend[1], trend)
trend := trend == -1 and close > dn1 ? 1 : trend == 1 and close < up1 ? -1 : trend

// === Signals ===
buySignal = trend == 1 and trend[1] == -1
sellSignal = trend == -1 and trend[1] == 1

// === Track Entry Price and Initial Stop ===
var float entryPrice = na
var float initialStop = na
var float takeProfit = na

// === Strategy Logic ===
// Long Entry: When Supertrend flips to bullish
if buySignal and strategy.position_size == 0
    entryPrice := close
    initialStop := up  // Use the GREEN Supertrend line as stop for longs

    // Calculate take profit based on risk-reward ratio
    stopDistance = entryPrice - initialStop
    takeProfit := entryPrice + (stopDistance * riskRewardRatio)

    strategy.entry('Long', strategy.long, comment='Long Entry')

    if showsignals
        debugText = 'ðŸŸ¢ LONG\nEntry: ' + str.tostring(entryPrice, format.mintick) + '\nSL: ' + str.tostring(initialStop, format.mintick) + '\nTP: ' + str.tostring(takeProfit, format.mintick) + '\nRR: ' + str.tostring(riskRewardRatio, '#.#') + ':1'
        label.new(bar_index, low, debugText, style=label.style_label_up, color=color.new(color.green, 0), textcolor=color.white, size=size.small)

// Short Entry: When Supertrend flips to bearish
if sellSignal and strategy.position_size == 0
    entryPrice := close
    initialStop := dn  // Use the RED Supertrend line as stop for shorts

    // Calculate take profit based on risk-reward ratio
    stopDistance = initialStop - entryPrice
    takeProfit := entryPrice - (stopDistance * riskRewardRatio)

    strategy.entry('Short', strategy.short, comment='Short Entry')

    if showsignals
        debugText = 'ðŸ”´ SHORT\nEntry: ' + str.tostring(entryPrice, format.mintick) + '\nSL: ' + str.tostring(initialStop, format.mintick) + '\nTP: ' + str.tostring(takeProfit, format.mintick) + '\nRR: ' + str.tostring(riskRewardRatio, '#.#') + ':1'
        label.new(bar_index, high, debugText, style=label.style_label_down, color=color.new(color.red, 0), textcolor=color.white, size=size.small)

// === Trailing Stop and Take Profit Management ===
// Long position management
if strategy.position_size > 0
    currentStop = trailWithSupertrend ? up : initialStop  // Trail with GREEN line for longs

    if useTakeProfit
        strategy.exit('Long Exit', 'Long', stop=currentStop, limit=takeProfit)
    else
        strategy.exit('Long Exit', 'Long', stop=currentStop)

// Short position management
if strategy.position_size < 0
    currentStop = trailWithSupertrend ? dn : initialStop  // Trail with RED line for shorts

    if useTakeProfit
        strategy.exit('Short Exit', 'Short', stop=currentStop, limit=takeProfit)
    else
        strategy.exit('Short Exit', 'Short', stop=currentStop)

// Reset on position close
if strategy.position_size == 0 and strategy.position_size[1] != 0
    entryPrice := na
    initialStop := na
    takeProfit := na

// === Visual Elements ===
upPlot = plot(trend == 1 ? up : na, title='Up Trend', style=plot.style_linebr, linewidth=2, color=color.green)
plotshape(buySignal ? up : na, title='UpTrend Begins', location=location.absolute, style=shape.circle, size=size.tiny, color=color.new(color.green, 0))
plotshape(buySignal and showsignals ? up : na, title='Buy', text='Buy', location=location.absolute, style=shape.labelup, size=size.tiny, color=color.new(color.green, 0), textcolor=color.white)

dnPlot = plot(trend == 1 ? na : dn, title='Down Trend', style=plot.style_linebr, linewidth=2, color=color.red)
plotshape(sellSignal ? dn : na, title='DownTrend Begins', location=location.absolute, style=shape.circle, size=size.tiny, color=color.new(color.red, 0))
plotshape(sellSignal and showsignals ? dn : na, title='Sell', text='Sell', location=location.absolute, style=shape.labeldown, size=size.tiny, color=color.new(color.red, 0), textcolor=color.white)

// Plot stop loss and take profit levels
plot(strategy.position_size != 0 and not na(takeProfit) ? takeProfit : na, title='Take Profit', color=color.new(color.yellow, 0), linewidth=1, style=plot.style_circles)
plot(strategy.position_size > 0 ? up : na, title='Long Stop (Supertrend)', color=color.new(color.red, 0), linewidth=1, style=plot.style_circles)
plot(strategy.position_size < 0 ? dn : na, title='Short Stop (Supertrend)', color=color.new(color.red, 0), linewidth=1, style=plot.style_circles)

mPlot = plot(ohlc4, title='', style=plot.style_circles, linewidth=0, display=display.none)

longFillColor = highlighting ? (trend == 1 ? color.new(color.green, 90) : color.new(color.white, 100)) : color.new(color.white, 100)
shortFillColor = highlighting ? (trend == -1 ? color.new(color.red, 90) : color.new(color.white, 100)) : color.new(color.white, 100)

fill(mPlot, upPlot, title='UpTrend Highlighter', color=longFillColor)
fill(mPlot, dnPlot, title='DownTrend Highlighter', color=shortFillColor)

// === Alerts ===
alertcondition(buySignal, title='SuperTrend Buy', message='SuperTrend Buy!')
alertcondition(sellSignal, title='SuperTrend Sell', message='SuperTrend Sell!')
changeCond = trend != trend[1]
alertcondition(changeCond, title='SuperTrend Direction Change', message='SuperTrend has changed direction!')
